<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="So I have an infinite for loop however I want to use defer to make my intention clearer.
Problem is this defer would never run because my function wouldn&rsquo;t return. This in turn would give you memory leak.
As neat as it could be, you can use a closure/anonymous function for this.
for x := 0; x &lt; 2; x&#43;&#43; { func() { defer fmt.Println(x) }() }  Real world use case: So what I&rsquo;m trying to do is to have an infinite polling using context on AWS SQS to add a timeout if something is wrong with SQS(this can be anything from network errors to aws being down, it can happen).">

<meta property="og:title" content="golang: defer inside a for loop" />
<meta property="og:description" content="So I have an infinite for loop however I want to use defer to make my intention clearer.
Problem is this defer would never run because my function wouldn&rsquo;t return. This in turn would give you memory leak.
As neat as it could be, you can use a closure/anonymous function for this.
for x := 0; x &lt; 2; x&#43;&#43; { func() { defer fmt.Println(x) }() }  Real world use case: So what I&rsquo;m trying to do is to have an infinite polling using context on AWS SQS to add a timeout if something is wrong with SQS(this can be anything from network errors to aws being down, it can happen)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zkanda.github.io/code/defer-inside-a-for-loop/" />



<meta property="article:published_time" content="2017-08-02T09:17:25&#43;00:00"/>

<meta property="article:modified_time" content="2017-08-02T09:17:25&#43;00:00"/>












<title>


     golang: defer inside a for loop 

</title>
<link rel="canonical" href="https://zkanda.github.io/code/defer-inside-a-for-loop/">










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    <link rel="stylesheet" href="https://zkanda.github.io/css/reset.css">
    <link rel="stylesheet" href="https://zkanda.github.io/css/pygments.css">
    <link rel="stylesheet" href="https://zkanda.github.io/css/main.css">
    




<link rel="shortcut icon"

    href="https://zkanda.github.io/img/favicon.ico"

>








</head>


<body lang="">

<section class="header">
    <div class="container">
        <div class="content">
            
            <a href="https://zkanda.github.io/"><div class="name"></div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-code"><a href="https://zkanda.github.io/code/"><span>Code</span></a></li>
                    
                        <li class="nav-photo"><a href="https://zkanda.github.io/photo/"><span>Photo</span></a></li>
                    
                        <li class="nav-about"><a href="https://zkanda.github.io/about/"><span>About</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        

        

	

        

        

        

        

        

        

        

        

        

        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <div class="page-heading">

    golang: defer inside a for loop

</div>

            <div class="markdown">
                

<p>So I have an infinite <code>for loop</code> however I want to use <code>defer</code> to make my intention clearer.</p>

<p>Problem is this <code>defer</code> would never run because my function wouldn&rsquo;t return. This in turn would give you memory leak.</p>

<p>As neat as it could be, you can use a closure/anonymous function for this.</p>

<pre><code class="language-go">	for x := 0; x &lt; 2; x++ {
		func() {
			defer fmt.Println(x)
		}()
	}
</code></pre>

<h3 id="real-world-use-case">Real world use case:</h3>

<p>So what I&rsquo;m trying to do is to have an infinite polling using <code>context</code> on <a href="https://docs.aws.amazon.com/sdk-for-go/v1/developer-guide/sqs-example-enable-long-polling.html">AWS SQS</a> to add a timeout if something is wrong with SQS(this can be anything from network errors to aws being down, it can happen).</p>

<pre><code class="language-go">package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;time&quot;

	&quot;github.com/aws/aws-sdk-go/aws&quot;
	&quot;github.com/aws/aws-sdk-go/aws/session&quot;
	&quot;github.com/aws/aws-sdk-go/service/sqs&quot;
)

func main() {
	sess := session.Must(session.NewSessionWithOptions(session.Options{
		SharedConfigState: session.SharedConfigEnable,
	}))

	svc := sqs.New(sess)

	var timeout int64 = 5

	// URL to our queue
	qURL := &quot;https://sqs.eu-west-1.amazonaws.com/237546493679/test-context-timeout&quot;

	for {
		func() {
			ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
			defer cancel()

			result, err := svc.ReceiveMessageWithContext(ctx, &amp;sqs.ReceiveMessageInput{
				MaxNumberOfMessages: aws.Int64(10),
				QueueUrl:            &amp;qURL,
				WaitTimeSeconds:     aws.Int64(timeout),
			})

			if err != nil {
				fmt.Println(&quot;Error&quot;, err)
				return
			}

			fmt.Printf(&quot;Received %d messages.\n&quot;, len(result.Messages))
			if len(result.Messages) &gt; 0 {
				fmt.Println(result.Messages)
			}

		}()
	}
}
</code></pre>

            </div>
        </div>
    </div>
</section>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-79101-12', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>







</body>
</html>

