<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="my random blabbing"><title>Full Disk Encrypted Ubuntu 20.04 in a small dedicated server. - intimacy of my thoughts</title><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/main.min.8022aa4b53ce57ff6f9cc4594360bfc15f2baeb5a018d0c68826f12da49a51e0.css integrity="sha256-gCKqS1POV/9vnMRZQ2C/wV8rrrWgGNDGiCbxLaSaUeA=" crossorigin=anonymous media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Didact+Gothic"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zkanda.io/tn.png"><meta name=twitter:title content="Full Disk Encrypted Ubuntu 20.04 in a small dedicated server."><meta name=twitter:description content="I miss the time when I was still exploring a lot of things in the Linux world.
Nowadays, I&rsquo;m mostly working with servers that are pre-provisioned and almost ready out of the box.
Those are nice conveniences for work. I decided though to go back and be like me again ten years ago.
Requirements:
 Experiments with small dedicated server It should be encrypted on disk. Have fun while doing it."><meta property="og:title" content="Full Disk Encrypted Ubuntu 20.04 in a small dedicated server."><meta property="og:description" content="I miss the time when I was still exploring a lot of things in the Linux world.
Nowadays, I&rsquo;m mostly working with servers that are pre-provisioned and almost ready out of the box.
Those are nice conveniences for work. I decided though to go back and be like me again ten years ago.
Requirements:
 Experiments with small dedicated server It should be encrypted on disk. Have fun while doing it."><meta property="og:type" content="article"><meta property="og:url" content="https://zkanda.io/src/full-disk-encrypted-ubuntu-20.04-on-oneprovider/"><meta property="og:image" content="https://zkanda.io/tn.png"><meta property="article:section" content="src"><meta property="article:published_time" content="2020-06-07T11:46:49+07:00"><meta property="article:modified_time" content="2020-06-07T11:46:49+07:00"><meta property="og:site_name" content="intimacy of my thoughts"><title>Full Disk Encrypted Ubuntu 20.04 in a small dedicated server.</title></head><body><header class="wrap flex-container"><h1>Full Disk Encrypted Ubuntu 20.04 in a small dedicated server.</h1></header><main class=wrap><article role=article class=flex-container><p>I miss the time when I was still exploring a lot of things in the Linux world.</p><p>Nowadays, I&rsquo;m mostly working with servers that are pre-provisioned and almost ready out of the box.</p><p>Those are nice conveniences for work. I decided though to go back and be like me again ten years ago.</p><p>Requirements:</p><ul><li>Experiments with small dedicated server</li><li>It should be encrypted on disk.</li><li>Have fun while doing it.</li></ul><h2 id=server-providers class=anchor-link><a href=#server-providers>Server Providers<span class=pilcrow>&nbsp;¶</span></a></h2><p>I looked into two dedicated, Kimsufi and One Provider seems to fit my needs.</p><p>I benchmark CPU and Networking to see which one is better, and I&rsquo;m pleased with One Provider more.
Huge plus also on their dashboard. Their web interface is responsive, unlike Kimsufi.</p><h2 id=diving-in class=anchor-link><a href=#diving-in>Diving in<span class=pilcrow>&nbsp;¶</span></a></h2><p>Frankly, I don&rsquo;t know how to set up a server from scratch even though I&rsquo;ve set up Arch and the likes many times. I just don&rsquo;t do it enough to memorize it. So I searched the web and found this <a href=https://opsblog.net/posts/full-disk-encrypted-ubuntu-kimsufi-sever/>excellent article</a></p><p>So, for the most part, it&rsquo;s a rewritten parts of that article updated using Ubuntu 20.04 and using OneProvider as a server provider.</p><p>I won&rsquo;t go as detailed, though.</p><h3 id=boot-into-rescue-mode class=anchor-link><a href=#boot-into-rescue-mode>Boot into rescue mode<span class=pilcrow>&nbsp;¶</span></a></h3><p>This one is interesting. It won&rsquo;t let me boot into rescue mode first without installing something in their UI first. So I tried Arch, and as far as I can tell, it works.</p><p>But that&rsquo;s not really what I want, so I went to <code>Boot Mode</code>, click the <code>BOOT IN RESCUE MODE (PLEASE SELECT A RESCUE IMAGE)</code>, selected the <code>Ubuntu-18.04_amd64</code> image and press <code>Boot</code>.</p><p>The server will automatically restart and the current page will give you the creds on how to connect and login in to the server.</p><h3 id=setting-up-the-server class=anchor-link><a href=#setting-up-the-server>Setting up the server<span class=pilcrow>&nbsp;¶</span></a></h3><p>Once you&rsquo;re connected, it&rsquo;s time to setup the disk and installs Ubuntu on it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># Turn off the swap, not sure why it&#39;s on in the first place</span>
sudo swapoff -a
<span style=color:#75715e># Erase the entire</span>
wipefs -a /dev/sda
<span style=color:#75715e># Create MBR layour</span>
parted -a optimal /dev/sda mklabel msdos
<span style=color:#75715e># Create first 512MiB partition</span>
parted /dev/sda -a optimal mkpart primary 0% 512MiB
<span style=color:#75715e># Create partition in remaining disk space</span>
parted /dev/sda -a optimal mkpart primary 512MiB 100%
<span style=color:#75715e># Set first partition as bootable</span>
parted /dev/sda set <span style=color:#ae81ff>1</span> boot on
</code></pre></div><p>Install and update packages.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>apt update <span style=color:#f92672>&amp;&amp;</span> apt install -y cryptsetup debootstrap
</code></pre></div><p>Format boot partition.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mkfs.ext4 /dev/sda1
</code></pre></div><p>Encrypt the disk with a strong passphrase.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cryptsetup -q -s <span style=color:#ae81ff>512</span> -c aes-xts-plain64 luksFormat /dev/sda2
</code></pre></div><p>Get the UUID of the second disk for fstab later.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cryptsetup luksDump /dev/sda2 | grep UUID | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span>
</code></pre></div><p>Open the encrypted partition.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cryptsetup luksOpen /dev/sda2 root
<span style=color:#75715e># this will be opened in /dev/mapper/root</span>
</code></pre></div><p>Format it</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mkfs.ext4 /dev/mapper/root
</code></pre></div><p>Now we are ready to install Ubuntu 20.04.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># mount the encrypted partition</span>
mount /dev/mapper/root /mnt
<span style=color:#75715e># mount the boot partition</span>
mkdir /mnt/boot <span style=color:#f92672>&amp;&amp;</span> mount /dev/sda1 /mnt/boot
<span style=color:#75715e># minimal installation</span>
debootstrap --arch amd64 focal /mnt http://mirrors.online.net/ubuntu
</code></pre></div><p>Let&rsquo;s get some coffee and relax for now.</p><p>After that, let&rsquo;s get inside the newly installed system.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mount -o bind /dev /mnt/dev
mount -t proc proc /mnt/proc
mount -t sysfs sys /mnt/sys
chroot /mnt /bin/bash
</code></pre></div><p>I&rsquo;m greeted by this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>bash: warning: setlocale: LC_ALL: cannot change locale <span style=color:#f92672>(</span>en_US.UTF-8<span style=color:#f92672>)</span>
<span style=color:#75715e># quick fix</span>
locale-gen en_US.UTF-8
</code></pre></div><p>Put the saved UUID previously into crypttab.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;root UUID=&lt;SAVED_UUID&gt; none luks&#34;</span> &gt; /etc/crypttab
</code></pre></div><p>Create fstab file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat <span style=color:#e6db74>&lt;&lt; EOF &gt; /etc/fstab
</span><span style=color:#e6db74>/dev/mapper/root / ext4 defaults,relatime 0 1
</span><span style=color:#e6db74>/dev/sda1 /boot ext4 defaults,relatime 0 2
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Not sure what this does.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ln -sf /proc/mounts /etc/mtab
</code></pre></div><p>Configure network. I will be using the new default netplan.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat <span style=color:#e6db74>&lt;&lt; EOF &gt;&gt; /etc/netplan/01-netcfg.yaml
</span><span style=color:#e6db74>network:
</span><span style=color:#e6db74>  ethernets:
</span><span style=color:#e6db74>    eth0:
</span><span style=color:#e6db74>      dhcp4: true
</span><span style=color:#e6db74>      nameservers:
</span><span style=color:#e6db74>        addresses:
</span><span style=color:#e6db74>          - &#34;8.8.8.8&#34;
</span><span style=color:#e6db74>          - &#34;8.8.4.4&#34;
</span><span style=color:#e6db74>  renderer: networkd
</span><span style=color:#e6db74>  version: 2
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Hostnames</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;&lt;hostname&gt;&#34;</span> &gt; /etc/hostname
echo <span style=color:#e6db74>&#34;127.0.1.1 &lt;hostname&gt;.&lt;domain&gt; &lt;hostname&gt;&#34;</span> &gt;&gt; /etc/hosts
</code></pre></div><p>Timezones</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;UTC&#34;</span> &gt; /etc/timezone
dpkg-reconfigure -f noninteractive tzdata
</code></pre></div><p>Update apt sources.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat <span style=color:#e6db74>&lt;&lt; EOF &gt; /etc/apt/sources.list
</span><span style=color:#e6db74>deb http://mirrors.online.net/ubuntu focal main restricted universe multiverse
</span><span style=color:#e6db74>deb http://mirrors.online.net/ubuntu focal-updates main restricted universe multiverse
</span><span style=color:#e6db74>deb http://mirrors.online.net/ubuntu focal-security main restricted universe multiverse
</span><span style=color:#e6db74>deb http://mirrors.online.net/ubuntu focal-backports main multiverse restricted universe
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Install packages</p><p>When a prompt ask where to install bootloader, select the first option.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>apt update <span style=color:#f92672>&amp;&amp;</span> apt install -y <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    busybox console-setup <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    cryptsetup cryptsetup-initramfs <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    dropbear dropbear-initramfs <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    grub-pc initramfs-tools kbd <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    linux-image-generic-hwe-20.04
    linux-tools-generic-hwe-20.04 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    locales ssh
</code></pre></div><p>SSH Keys</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mkdir /root/.ssh <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>600</span> /root/.ssh
echo <span style=color:#e6db74>&#34;&lt;PUBLIC_SSH_KEY&gt;&#34;</span> &gt; /root/.ssh/authorized_keys
echo <span style=color:#e6db74>&#34;&lt;PUBLIC_SSH_KEY&gt;&#34;</span> &gt; /etc/dropbear-initramfs/authorized_keys
</code></pre></div><p>Configuring dropbear.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sed -i <span style=color:#e6db74>&#39;s/local flags=\&#34;Fs\&#34;/local flags=\&#34;F\&#34;/&#39;</span> /usr/share/initramfs-tools/scripts/init-premount/dropbear

cat <span style=color:#e6db74>&lt;&lt; EOF &gt; /etc/initramfs-tools/hooks/passwd_hook.sh
</span><span style=color:#e6db74>#!/bin/sh
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>PREREQ=&#34;&#34;
</span><span style=color:#e6db74>prereqs()
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>echo &#34;\$PREREQ&#34;
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>case \$1 in
</span><span style=color:#e6db74>    prereqs)
</span><span style=color:#e6db74>        prereqs
</span><span style=color:#e6db74>        exit 0
</span><span style=color:#e6db74>    ;;
</span><span style=color:#e6db74>esac
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>grep -e root /etc/shadow &gt; \${DESTDIR}/etc/shadow
</span><span style=color:#e6db74>EOF</span>

chmod +x /etc/initramfs-tools/hooks/passwd_hook.sh
</code></pre></div><p>Bootloader and network interface.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sed -i s/GRUB_CMDLINE_LINUX<span style=color:#f92672>=</span><span style=color:#ae81ff>\&#34;\&#34;</span>/GRUB_CMDLINE_LINUX<span style=color:#f92672>=</span><span style=color:#ae81ff>\&#34;</span>net.ifnames<span style=color:#f92672>=</span>0<span style=color:#ae81ff>\ </span>biosdevname<span style=color:#f92672>=</span>0<span style=color:#ae81ff>\ </span>ip<span style=color:#f92672>=</span>:::::eth0:dhcp<span style=color:#ae81ff>\&#34;</span>/g /etc/default/grub
</code></pre></div><p>Update grub and initramfs</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>update-grub <span style=color:#f92672>&amp;&amp;</span> update-initramfs -u
</code></pre></div><p>Exit chroot and unmount disk.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>exit
umount /mnt/<span style=color:#f92672>{</span>boot,dev,proc,sys<span style=color:#f92672>}</span>
umount /mnt
cryptsetup luksClose root
</code></pre></div><p>Whew, that was a lot of copy paste&mldr;</p><h3 id=the-moment-of-truth class=anchor-link><a href=#the-moment-of-truth>The moment of truth.<span class=pilcrow>&nbsp;¶</span></a></h3><p>Go back to OneProvider dashboard, go into boot mode again, select <code>BOOT IN NORMAL MODE</code> and click <code>Boot</code>.</p><p>It should automatically restart the machine and boot in normal disk.</p><p>Before we can use the server, we have to connect to the server first and unlock the disk.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ssh root@IP
cryptroot-unlock
</code></pre></div><p>Enter your password when prompted.
If it&rsquo;s a success, it will disconnect you from the server. Connect again like any standard server.</p><p>Alright, take another sip of that coffee. :)</p><h2 id=so-what-now class=anchor-link><a href=#so-what-now>So what now?<span class=pilcrow>&nbsp;¶</span></a></h2><p>This is already a second server that I did and the article is base on that experience. The first one is in Kimsufi and apart from booting the rescue mode. There&rsquo;s almost no difference between the two.</p><p>I had a lot of fun setting this up, and I&rsquo;m already using the previous server to host <a href=https://thelounge.chat/>lounge</a> a self hosted IRC client and I&rsquo;ve been pleased with it so far.</p><p>My hope for this article is to show you dear reader that its not that complicated to have a relatively secure system that you control and have fun while doing it.</p><p>Maintaining and monitoring a server though is another thing, and I might write more articles about it once I could try the tools that I&rsquo;m planning to use.</p></article><nav role=navigation class="flex-container bottom-menu"><hr><p><a href=/posts>posts</a>
&#183;
<a href=/about>who is zak?</a>
&#183;
<a href=/src>src</a>
&#183;
<a href=/>main</a></p></nav></main><footer class="flex-container footer">You only live once, smile and make it count.</footer></body></html>